--- 
title: "中国矿业大学（北京）硕士学位论文模板"
author: "某壮士制作"
date: "`r Sys.Date()`"
site: bookdown::bookdown_site
documentclass: ctexbook
geometry: [tmargin=3.0cm, bmargin=3.0cm, lmargin=3.0cm, rmargin=3.0cm]
classoption: "hyperref, a4paper, UTF8, zihao = -4, linespread = 1.25"
bibliography: [book.bib, packages.bib, articles.bib]
biblio-style: thuthesis-numeric
natbiboptions: super,square
link-citations: yes
colorlinks: yes
---

```{r setup,include=FALSE}
knitr::opts_chunk$set(echo = TRUE, collapse = TRUE, fig.align = 'center',
                      fig.showtext = ifelse(.Platform$OS.type != 'unix',FALSE,TRUE),
                      out.width = '.7\\textwidth')
```

# 引言

\pagenumbering{arabic}

本模板基于 bookdown 制作，得益于 pandoc，有关如何在线发布书籍，请看文献 [@bookdown2016CRC] 第六章，以及文献 [@blogdown2017CRC] 第三章。这个模板说明最终将会在线发布，点击页面左上角的下载按钮可获得本文的 PDF 或者 EPUB 电子版。

- 模板框架（完成）
- 字体设置（完成）
- 附录设置（完成）
- 页眉页脚（完成）
- 目录设置（完成）
- 章节样式（完成） 
- 参考文献（完成）

已经审查如下部分

- 字距
- 行距
- 字号（章节、段落等）
- 段前段后行距 
- 封面 
- 授权页
- 摘要

比如数字，字母的字体设置： 正文、页眉数字用 Times New Roman， 一级标题（章）数字用 Arial，二级（节）、三级标题（小节）数字用 Times New Roman

下面的等自己的论文搞定后再做

- 数学公式、插图排版格式（请见 bookdown 官方文档或者）
- 图的格式要求：图中数字、中英文字体设置（参看学校模板要求，这是绘图要求，本不在此模板范围内）
- 模板使用说明（有时间再做）

参考文献标准 GB/T 7714\-2015，而我校还在使用 2005 版，不过就我校的格式要求来看没什么区别，因此从 [thuthesis](https://github.com/xueruini/thuthesis) 模板拷贝了参考文献样式设置文件 `thuthesis-numeric.bst`

模板文件目前基于 `rticles`包的 `ctex`修改得到，请安装

```r
devtools::install_github('XiangyunHuang/rticles')
```

以后会考虑使用Pandoc默认的模板 <https://github.com/jgm/pandoc-templates/blob/master/default.latex>，如果 rmarkdown 、rticles 针对pandoc模板更新的话


## 插图

图中字体为宋体，5号，数字、字母一律 Times New Roman
图名字体设置同上

```r
## base plot 请使用 pdf 而不是 cairo_pdf
pdf(file = 'base-plot-fontset-cairo-pdf.pdf')
with(iris, {
  par(family = 'Times')
  plot(Sepal.Length, Sepal.Width, col = Species, family = 'Times')
  title(main = '鸢尾花数据', family = "GB1")
  legend("topright", legend = levels(Species), col = 1:3, pch = 21)
})
dev.off()
```

```{r,echo=FALSE}
knitr::include_graphics(path = 'figures/base-plot-fontset-cairo-pdf.pdf')
```

pdf 图形设备自带的字体支持

```{r}
names(pdfFonts())
```

还可以插入 bash 

```{bash}
tlmgr list --only-installed | head -n 6 # 列出安装的 TeX 包 
```

借助 [showtext](https://github.com/yixuan/showtext) 包可以获得更加精确的字体定制，

```{r font-add}
library(showtext) # 加载 showtext 包
font_install(source_han_serif()) # 安装思源宋体
font_families() # 查看可供用showtext使用的字体
```

使用新添加的思源字体

```{r fiji,fig.width=8,fig.height=6}
library(maps)
library(mapdata)
library(ggplot2)
FijiMap <- map_data("worldHires", region = "Fiji" ) 
ggplot(FijiMap, aes(x = long, y = lat)) + 
  geom_map( map = FijiMap, aes(map_id = region),size =.2 ) +
  geom_point(data = quakes, pch = 16, 
             aes(x = long, y =  lat, colour = mag)) +
  xlim(160, 195) + 	 
  scale_colour_distiller(palette = "Spectral") +
  scale_y_continuous(breaks=(-18:18)*5) +
  coord_map("ortho", orientation = c(-10,180,0)) +
  labs(colour = "震级", x = "经度", y = "纬度", title = '斐济地震带') +
  theme_minimal() +
  theme(title = element_text( family = "source-han-serif-cn" ), 
        axis.title = element_text( family = "source-han-serif-cn" ),
        legend.title = element_text( family = "source-han-serif-cn" ),
        legend.position = c(1,0), legend.justification = c(1,0))
```



### 绘图的正确姿势 

壮士论文中的图大多是 Base R 风格，以 `plot` 为核心，辅之以 `par`（全局版式）、 `(m)text`（添加文本）、`title`（标题）、`legend`（图例）、`axis` （坐标轴）等精调函数，打造出版级的图形，这种代码有两个极其优良的特点：执行效率高和高稳定性。

但是，看似越简单的东西实现起来越复杂，下面这个例子摘自 [Jumping Rivers](http://blog.jumpingrivers.com/posts/2018/2018-01-24-base-r-graphics/)，想画好不容易的，壮士慢慢体会从图 \@ref(fig:iris-plot) 到图 \@ref(fig:pretty-iris)的区别，另外有一份来自统计之都的资料---[漫谈条形图](https://cosx.org/2017/10/discussion-about-bar-graph/)，值得一读。

```{r iris-plot,fig.cap='散点图的错误示范'}
with(iris, {
  plot(Sepal.Length, Sepal.Width, col = Species, main = '鸢尾花数据')
  legend("topright", legend = levels(Species), col = 1:3, pch = 21)
})
```
```{r pretty-iris,fig.cap='基本正确的绘图姿势'}
## Same as geom_jitter
iris$Sepal.Length = jitter(iris$Sepal.Length)
iris$Sepal.Width = jitter(iris$Sepal.Width)
alpha = 150 # Transparent points
palette(c(rgb(200, 79, 178, alpha = alpha, maxColorValue = 255), 
          rgb(105, 147, 45, alpha = alpha, maxColorValue = 255),
          rgb(85, 130, 169, alpha = alpha, maxColorValue = 255)))

par(mar = c(3, 3, 2, 1), # Dist' from plot to side of page
    mgp = c(2, 0.4, 0), # Dist' plot to label
    las = 1, # Rotate y-axis text
    tck = -.01, # Reduce tick length
    xaxs = "i", yaxs = "i") # Remove plot padding
plot(iris$Sepal.Length, iris$Sepal.Width, 
     bg = iris$Species, # Fill colour
     pch = 21, # Shape: circles that can filed
     xlab = "Sepal Length", ylab = "Sepal Width", # Labels
     axes = FALSE, # Don't plot the axes
     frame.plot = FALSE, # Remove the frame 
     xlim = c(4, 8), ylim = c(2, 4.5), # Limits
     panel.first = abline(h = seq(2, 4.5, 0.5), col = "grey80"))
at = pretty(iris$Sepal.Length)
mtext(side = 1, text = at, at = at, 
      col = "grey20", line = 1, cex = 0.9)
at = pretty(iris$Sepal.Width)
mtext(side = 2, text = at, at = at, col = "grey20", line = 1, cex = 0.9)
text(5, 4.2, "setosa", col = rgb(200, 79, 178, maxColorValue = 255))
text(5.3, 2.1, "versicolor", col = rgb(105, 147, 45, maxColorValue = 255))
text(7, 3.7, "virginica", col = rgb(85, 130, 169, maxColorValue = 255))
title("The infamous IRIS data", adj = 1, 
      cex.main = 0.8, font.main = 2, col.main = "black")
```


再来一个 Base R 风格的集合，如图 \@ref(fig:plot-object)所示，包含时间序列图、散点图、条形图、直方图等

```{r plot-object,fig.cap='plot对象集合',out.width = '\\textwidth'}
layout(matrix(seq(6), 2, 3, byrow = TRUE))
op <- par(mar=c(2,2,.5,.5))
# 分类散点图
plot(Sepal.Length~Sepal.Width,data=iris,col = Species,pch=16 )
legend('topright',legend = unique(iris$Species),box.col = "gray",
       pch=16,col = unique(iris$Species) )
box(col="gray")
# 气泡图
plot(Volume~Height,data = trees,pch =16,cex = Girth/8,
     col = rev(terrain.colors(nrow(trees), alpha = .5)))
box(col="gray")
# 折线图
plot(AirPassengers)
box(col="gray")
# 柱形图
set.seed(123456)
barPois <- table(stats::rpois(1000, lambda = 5))
plot(barPois,col = "lightblue",type = 'h',lwd=10,main = "")
box(col="gray")
# 马赛克图
plot(HairEyeColor,col = "lightblue",border = 'white',main = '')
# 直方图
set.seed(1234)
n <- 2^24
x <- runif(n,0,1)
delta <- 0.01
len <- diff(c(0,which(x < delta),n+1))-1
ylim <- seq( 0, 1800, by = 300)
xlim <- seq( 0, 100, by = 20)
p <- hist(len[len < 101], breaks = -1:100+0.5,plot = FALSE)
plot(p,ann = FALSE,axes = FALSE,col="lightblue",border = "white",main = "")	 
axis( 1, labels = xlim, at = xlim, las = 1) # x 轴
axis( 2, labels = ylim, at = ylim, las = 0) # y 轴
box(col="gray")
```

- 配色是使图形高大上的重要一环，此处资料参看 [colors in plot](https://github.com/XiangyunHuang/colors-in-plots)
- 一些基础的简单图形还是建议使用 [ggplot2](https://github.com/tidyverse/ggplot2)，一份 ggplot2 风格的绘图集合，请看网页 <http://www.ggplot2-exts.org/> ，下面还是以散点图为例，壮士可以比较图 \@ref(fig:base-ggplot) 和图 \@ref(fig:pretty-iris) 的细节差别。

```{r base-ggplot,fig.cap='散点图'}
library(ggplot2)
ggplot(iris, aes( Sepal.Length, Sepal.Width ) ) + 
  geom_point( aes( colour = Species ) ) +
  scale_colour_brewer( palette = "Set1" ) +
  labs(title = '鸢尾花数据的散点图', 
       x = '萼片长度', y = '萼片宽度', colour = '鸢尾花类别') +
  theme_minimal() +
  theme(axis.ticks = element_line( colour = "black" ),
        axis.line = element_line( size = 0.2 ))
```


### 代码块

代码块设置

```{r,collapse=TRUE}
1 + 2
set.seed(2018)
rnorm(5)
set.seed(2018)
diag(rnorm(5))
```

## 软件信息

编译环境

```{r}
sessionInfo()
```



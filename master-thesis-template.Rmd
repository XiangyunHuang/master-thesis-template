--- 
title: "Spatial Generalized Linear Mixed Models and its Applications"
subtitle: "master thesis template"
institute: "China University of Mining and Technology, Beijing"
author: "Xiangyun Huang"
date: "`r Sys.Date()`"
site: bookdown::bookdown_site
documentclass: ctexbook
geometry: [tmargin=3.0cm, bmargin=3.0cm, lmargin=3.0cm, rmargin=3.0cm]
classoption: "hyperref, a4paper, UTF8, zihao = -4, linespread = 1.3"
bibliography: [refer.bib,packages.bib]
natbiboptions: super,square
biblio-style: natbib
link-citations: yes
colorlinks: yes
---

```{r setup,include=FALSE}
knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  echo = FALSE,
  out.width = "70%",
  fig.align = 'center',
  fig.width = 6,
  fig.showtext = TRUE,
  fig.asp = 0.618,  # 1 / phi
  fig.show = "hold"
)
library(ggplot2)
theme_set(theme_minimal())
```

\mainmatter

# 符号说明

符号   | 含义             | 符号  | 含义
 :----------: |   :-------------------:   | :----------: |  :-------------------: 
$\mathbf{A}$               | 粗体            | $\Omega$                   | 全集
$\mathit{A}$               | 集合 文本斜体   | $\mathbb{R,C}$             | 实（复）数集
$\mathtt{A}$               | 文本等宽体      | $\mathrm{A}$               | 文本罗马体
$\mathcal{A}$              | 集族            | $\varnothing$              | 空集
$\mathsf{A}$               | 矩阵 文本等线体  | $\mathsf{A}^{-}$           | 矩阵的广义逆
$\mathsf{A}^\top$          | 矩阵转置        | $\bar{x}$                   | 平均值
$\mathsf{A}^{-1}$          | 矩阵的逆        | $\vert a \vert$             | 标量绝对值
$\mathsf{A}^{\star}$       | 伴随矩阵        | $\mathop{\mathrm{diag}}(\mathsf{A})$ | 矩阵的对角
$\lVert \mathsf{A} \rVert_{1}$       | 矩阵的1范数     | $\mathsf{I}$                | 单位矩阵
$\lVert \mathsf{A} \rVert_{2}$       | 矩阵的2范数     | $\mathsf{I}_{n}$            | $n$ 阶单位矩阵
$\lVert \mathsf{A} \rVert_{\infty}$  | 矩阵的无穷范数  | $\mathsf{1}$                | 全1矩阵
$\lVert \mathsf{X} \rVert_{1}$       | 向量的1范数     | $\mathsf{1}_{n}$            | $n$ 阶全1矩阵
$\lVert \mathsf{X} \rVert_{2}$       | 向量的2范数     | $\lVert \mathsf{X} \rVert_{\infty}$  | 向量的无穷范数
$\langle\mathsf{X},\mathsf{Y}\rangle$ | 向量的内积    | $f(\mathsf{X})$        | 随机变量的函数
$\mathsf{X} \wedge \mathsf{Y}$       | 向量的外积     | $\nabla{\mathsf{X}}$   | 向量微分或梯度
$\beta$                              | 模型系数             | $\theta$               | 模型或分布参数
$\alpha$                             | 模型截距             | $\Theta$               | 参数空间
$\hat{\beta}_{ls}$                   | LS估计     | $f(x)$                 | 标量值函数
$\hat{\beta}_{mle}$                  | MLE估计    | $f(\mathsf{X})$        | 向量的函数
$\hat{\beta}_{bayes}$                | Bayes估计  | $\mathcal{X}$          | 概率空间
$\rho$                              | 相关系数            | $\kappa$      | 贝塞尔函数的阶
$\phi$                              | 尺度参数            | $u$           | 距离 $\lVert \mathsf{x}_1 -\mathsf{x}_2 \rVert$
$\mathbb{R}^2$                      | 二维实数域        | $S(x)$        | 空间过程
$\mathcal{S}$      | $\mathcal{S} = \{S(x):x \in \mathbb{R}^2\}$ | $\mathcal{S}^{\star}$  | 随机过程 $\mathcal{S}$ 的近似

- 多元统计分析 高惠璇 矩阵符号表示
- 深度学习符号表示 <https://github.com/XiangyunHuang/dlbook>

举例，线性模型的表示，此处 $Y$ 为 $n\times 1$列向量，$X$ 为$p\times n$的矩阵，$\beta$ 为 $p\times 1$的列向量 ，$\epsilon$ 为$n\times1$列向量
$$Y = X'\beta + \epsilon$$
$$\mathsf{A} = \varGamma^\top\Lambda\varGamma$$
$$\mathsf{u} = (u_1,u_2,\cdots,u_n)$$
$$\mathsf{x} = (x_1,x_2,\cdots,x_n)$$
期望 $\mathsf{E}$ 正态分布 $\mathcal{N}(\mathsf{x};\mu,\Sigma)$
对数 $\log$ 协方差 $\mathsf{Cov},\mathsf{Var}$ 

矩阵 $$\mathsf{Y} = (\mathsf{y}^{(1)},\mathsf{y}^{(n)},\cdots,\mathsf{y}^{(n)})$$
其中 $\mathsf{y}^{(i)} = (y_{1i},y_{2i},\cdots,y_{ni})$ 表示第 $i$ 列

梅隆函数(Matern function)是描述空间相关性的常用函数，它带有两参数$\kappa$ 和 $\phi$，具体形式如下：
$$\rho(u) = \big\{2^{\kappa-1}\Gamma(\kappa)\big\}^{-1}(u/\phi)^{\kappa}K_{\kappa}(u/\phi)$$
其中，$K_{\kappa}(\cdot)$ 表示 $\kappa$ 阶修正的贝塞尔函数

- 向量 `\mathsf` $\mathsf{x} = (x_1,x_2,\cdots,x_n)$ 此处 $\mathsf{x}$ 是小写
- 矩阵 `\mathbf` 矩阵的向量表示，$\mathsf{X} = (\mathsf{x}^{(1)},\mathsf{x}^{(2)},\cdots,\mathsf{x}^{(n)})$ 此处 $\mathsf{X}$ 是大写，矩阵的元素表示 $\mathsf{X} = (x_{ij})_{n\times p}$


> 先不要管符号说明，把后续模型方程写完了再说



<!--chapter:end:index.Rmd-->

# 绪论{#intro}

## 背景 {#background}

- 解决（做）了什么问题，为什么做这个问题，是怎么做的，写发表的文章的三步走
What How
- 从 kriging 克里金插值到高斯过程，简单介绍提出本文的大纲思路

# 论文综述 {#review}

<!--chapter:end:01-intro.Rmd-->

# 模型 {#models}

## 线性模型  

线性模型的一般形式为
\begin{equation}
Y = X'\beta + \epsilon, \mathrm{E}(\epsilon) = 0, \mathrm{Cov}(\epsilon) = \sigma^2I \label{eq:LM}
\end{equation}
其中，$Y = (y_1,y_2,\cdots,y_n)'$ 是 $n$ 维列向量，代表对响应变量$Y$的$n$次重复观测；$\beta = (\beta_0,\beta_1,\cdots,\beta_{p-1})'$ 是 $p$ 维列向量，代表模型自变量 $X$ 的系数，$\beta_0$是截距项；
$X' = (1_{(1\times n)}',X_{(1)}',X_{(2)}',\cdots,X_{(n)}')$，$1_{(1\times n)}'$ 是全1的$n$维列向量，而$X_{(i)}' = (x_{1i},x_{2i},\cdots,x_{ni})'$ 代表对第$i$个自变量的$n$次观测；
$\epsilon = (\epsilon_1,\epsilon_2,\cdots,\epsilon_n)'$是$n$ 维列向量，代表模型的随机误差，$\mathrm{E}(\epsilon_i \epsilon_j) = 0, i \ne j$。 求解线性模型 \eqref{eq:LM} 的 R 函数是 `lm`，近年来，高维乃至超高维稀疏线性模型成为热门的研究方向，相关的 R 包也越来越多，比较著名的有`glmnet`[@glmnet2011JSS] 和 `SIS`[@SIS2016JSS]。


## 广义线性模型

广义线性模型的一般形式
\begin{equation}
Y \sim \text{指数族} \quad
\eta = X'\beta \quad
\mathrm{E}(Y) = g^{-1}(\eta)  \label{eq:GLM}
\end{equation}
简写之为
\begin{equation*}
g(\mu) = X'\beta
\end{equation*}
其中$\mu \equiv \mathrm{E}(Y)$， $g$ 代表联系函数，特别地，当 $Y \sim N(\mu,\sigma^2)$ 时，$g(x) = x$ ；当 $Y \sim \mathrm{Binomial}(n,p)$ 时，$g(x)=\ln(\frac{x}{1-x})$；当 $Y \sim \mathrm{Possion}(\lambda)$ 时，$g(x) = \ln(x)$；此处不一一列举。[@McCullagh1989] 
模型\eqref{eq:GLM}最早由 Nelder 和 Wedderburn [@Nelder1972]提出，它弥补了模型\eqref{eq:LM} 的两个重要缺点：一是因变量只能取连续值的情况，二是期望与自变量只能用线性关系联系 [@Chen2011]。求解广义线性模型 \eqref{eq:GLM} 的 R 函数是 `glm`，参数估计的办法一般是拟似然法。

## 混合效应模型  

广义线性混合模型的一般形式
\begin{equation}
g(\mu) = X'\beta + Z'b  \label{eq:GLMM}
\end{equation}
其中 $Z'$ 是$q$维随机效应的 $n \times q$ 的向量值矩阵。
混合效应模型包含线性混合效应模型、广义线性混合效应模型、非线性混合效应模型等，之所以称之为混合效应，是因为模型既包含固定效应(fixed-effects)又随机效应(random effects)。如前所述的线性和广义线性模型中的自变量就是固定效应，而随机效应是那些不能直接观察到的潜变量。求解模型\eqref{eq:GLMM}的R 包有 `nlme` [@R-nlme]，`mgcv` [@mgcv2017] 和`lme4`[@lme4JSS]，参数估计的方法一般有限制极大似然法。

在 S/R 语言中空间数据分析和建模，包括空间插值和平滑以及克里金方法等，此外，还介绍了线性和混合线性模型，广义线性和广义线性模型混合的求解方法与软件实现[@MASS2002]。

## 空间广义线性混合效应模型

本文重点关注空间广义线性混合效应模型(Spatial Generalized linear mixed-effects models，简写为SGLMM)，顾名思义，它既是对模型\eqref{eq:LM}、\eqref{eq:GLM}和\eqref{eq:GLMM}的延伸也是对空间数据分析的应用，属于空间统计下的地统计(geostatistics)分支，因此在有些参考文献中也称为广义线性地统计模型(Generalized linear geostatistical models)[@Diggle2007]。

\begin{equation}
g(\mu_i) = d(x_i)'\beta + S(x_i) + Z_i \label{eq:SGLMM}
\end{equation}
其中$d'(x_i)$代表协变量对应的数据向量，$x_i \in \mathbb{R}^2$ 代表相应的空间位置，即 $p$ 个协变量在第 $i$ 个位置的观察值。若响应变量$Y_i$服从二项分布$\mathrm{Bin}(n_i,p_i)$则 $g(\mu_i) = \log[p(x_i)/\{1-p(x_i)\}]$，若响应变量$Y_i$服从泊松分布$\mathrm{Pois}(\lambda_i)$则 $g(\mu_i) = \log(\lambda_i)$。

2002年张重点分析了模型\eqref{eq:SGLMM}的参数估计和模型预测的计算问题，提出MCML[@Zhang2002On]，2004年Christensen 将 MCML 方法应用于 Rongelap 数据分析[@Christensen2004]，2016年 Bonat 和 Ribeiro Jr. 综合比较了MCML、贝叶斯MCMC和INLA方法[@Bonat2016Practical]

模型\eqref{eq:SGLMM}具有广泛的应用，如分析核污染浓度的空间分布[@Diggle1998]，冈比亚儿童的疟疾流行度的空间分布估计和预测[@Diggle2002]，喀麦隆及其周边地区的热带眼线虫流行病的的空间分布的估计和预测[@Diggle2007ATMP]，以及对LFOEP项目（即Lymphatic Filariasis and Onchocerciasis Elimination Programs）的决策支持[@Schl2016Using]，Diggle 和 Giorgi 于2016年在SGLMM模型的基础上进行扩展，以适应三类新的调查数据，其一是组合随机调查数据和非随机调查数据（即潜在有偏的数据），以肯尼亚疟疾流行数据为例，组合了学校和社区的调查数据；其二是时空扩展，将时间因素考虑进模型，以马拉维2010年5月至2013年6月的疟疾流行数据为例；其三是混合分布，考虑响应变量 是混合二项分布的情况[@Diggle2016]，检验环境和基因效应在空间相关性中的存在性 [@spaMM2014]，流行现象的时空分析[@surveillance2017]，近年来涉及空间数据分析和建模的书籍也越来越多，用于空间数据分析的分层模型[@Banerjee2015]和基于 `R-INLA` 软件的空间和时空贝叶斯模型 [@Blangiardo2015]

作为模型\eqref{eq:SGLMM}求解和展示的首选工具 --- R 语言在空间数据分析与可视化方面呈现越来越流行的趋势，从早些年的 `lattice` 图形[@lattice2008] 到如今的 `ggplot2`图形[@ggplot22016]，操作空间数据的 `sp` 对象也发展为 `sf` 对象，同时整合了不少第三方软件和服务 如基于 Google Maps 的交互空间可视化 [@plotGoogleMaps2012]，基于 Google Earth 的空间可视化 [@plotKML2015] 

下面就求解模型\eqref{eq:SGLMM}的三类算法进行详细阐述，并介绍相应的软件实现。


<!--chapter:end:02-literature.Rmd-->

# 算法描述 {#algorithms}

## 贝叶斯方法

1998年 Diggle 等人最早提出基于模型的地统计学框架，将高斯空间随机过程和（广义）线性混合模型结合应用到空间流行病数据分析中，通过贝叶斯推断方法进行参数估计和预测[@Diggle1998]。

2002年 Diggle 等人使用空间广义线性混合模型分析冈比亚儿童疟疾的数据，在贝叶斯框架下，通过 Metropolis-Hastings 算法实现MCMC（马尔科夫链蒙特卡罗）方法进行参数估计和模型预测[@Diggle2002]。



一元和多元时空模型`spBayes`包 [@spBayes2015]
用于对MCMC的收敛性诊断和输出分析 [@coda2006]
geoR: 用于空间数据分析和预测的贝叶斯方法 [@geoR2001]
geoRglm: 空间广义线性混合效应模型 [@geoRglm2002]
brms [@brms2017JSS]
gstat [@gstat2016]

glmmBUGS RStan 实现MCMC 


```r
library(coda)
library(MCMCvis)
```

`MCMCvis`包[@R-MCMCvis]提取MCMC算法输出的结果并可视化，产生出版级的图形，提取模型参数等指标，支持诸如JAGS、Stan等软件求解贝叶斯模型的输出结果。

Stan 是一种概率编程语言[@Stan2017JSS]，可以替代 BUGS ( **B**ayesian inference **U**sing **G**ibbs **S**ampling ) [@BUGS] 作为 MCMC 的高效实现，可用于贝叶斯框架下，标准地统计模型的参数估计，Stan 提供多种语言的接口实现，方便起见，本文采用它提供的 R 语言接口 -- rstan 包 [@Stan2015;@Stan2017JSS]。此外，还有[@rethinking2015]  　


## 最大似然方法

由于贝叶斯方法构造MCMC链，需要很多次反复迭代，收敛速度慢，求解模型\eqref{eq:SGLMM}需要花费很多时间，将最大似然和重要性采样相结合的方法出现了，称之为蒙特卡罗最大似然法，简称 MCML

最大似然 [@PrevMap2017JSS] 将 MCML 和 MCMC 方法应用于空间广义线性混合效应模型的参数估计和预测，

mgcv and JAGS


## 拉普拉斯近似方法

方法 [@Rue2017arXiv]


<!--chapter:end:03-method.Rmd-->

# 数值模拟 {#simulations}

`RandomFields`是模拟多元随机场的 R 包 [@RandomFields2015]， `geoR` 包[@R-geoR2016]的 `grf` 函数只适合模拟少量数据点

分泊松、二项两种情况、上述3种方法，在空间广义线性混合效应模型下的模拟情况（使用标准的地统计模型，无时间项和混合分布）

## 响应变量服从二项分布的情形

模型形式如方程 \eqref{eq:SGPSM}所示，也称为标准地统计流行抽样模型（Standard Geostatistical Prevalence Sampling Model）
\begin{equation}
\log[p(x_i)/\{1-p(x_i)\}] = d(x_i)'\beta + S(x_i) + Z_i \label{eq:SGPSM}
\end{equation}
其中 $\mathcal{S} = \{S(x):x \in \mathbb{R}^2\}$


## 响应变量服从泊松分布的情形

模型形式如方程 \eqref{eq:SGPSM2} 所示
\begin{equation}
\log[\lambda(x_i)] = d(x_i)'\beta + S(x_i) + Z_i \label{eq:SGPSM2}
\end{equation}


```{r matern, fig.width = 6, fig.height = 5,echo=FALSE,cache=TRUE}
source('code/02-Matern-function.R') 
```

从蓝到红，值由小变大

## 模拟二项分布数据集

此处模拟数据集 `data_sim` 来自 `PrevMap` 包，零均值高斯过程 单元格上 $30 \times 30$ 参数 
$\sigma^2 = 1, \phi = 0.15, \kappa =  2$，块金效应 (nugget effect) $\tau^2 = 0$，每个格点上重复实验10次，得到响应变量二项分布的概率值


```{r low-rank,fig.cap="数值模拟",fig.pos="!htb"}
knitr::include_graphics(rep("figures/simulation.pdf",2))
```


```{r cumtb-demo,fig.cap=c("CUMTB1","CUMTB2","CUMTB3"), out.width='33%'}
knitr::include_graphics(rep("figures/cumtb.pdf",3))
```


```{r two-figures, fig.cap="两个图并排", out.width='50%'}
par(mar = c(4, 4, 0.1, 0.1))
plot(pressure, pch = 19, type = "b")
plot(cars, pch = 19)
```


# 案例分析 {#cases}

## 冈比亚儿童疟疾的空间分布

贝叶斯方法
二项分布

## 喀麦隆及周边地区眼线虫病的空间分布

二项分布
MCML 和 低秩近似 贝叶斯

## 朗格拉普岛核爆炸残留物的空间分布

泊松分布

## 城市重金属污染浓度分布


响应变量是高斯

As 浓度 海拔 区域

广义线性模型  带分类变量

空间高斯分布


<!--chapter:end:04-application.Rmd-->

# 结论与展望 {#summary}

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r faithful}
summary(faithful)
```


<!--chapter:end:05-summary.Rmd-->

`r if (knitr:::is_html_output()) '# 参考文献 {-}'`

<!--chapter:end:06-references.Rmd-->

